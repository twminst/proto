<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ignite — App Layout</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible+Next:ital,wght@0,100..900;1,100..900&family=Inclusive+Sans:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
    }

    body {
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      background: #f2f4f5;
    }

    /* ─── Page wrapper ─────────────────────────────────────────── */
    .page-wrapper {
      width: 100%;
      height: 100vh;
      background: #f2f4f5;
      display: flex;
      overflow: hidden;
    }

    /* ─── Sidebar ──────────────────────────────────────────────── */
    .sidebar {
      width: 94px;
      height: 100%;
      padding: 12px;
      flex-shrink: 0;
    }

    .sidebar-card {
      background: #fff;
      border-radius: 16px;
      height: 100%;
      display: flex;
      flex-direction: column;
      box-shadow: 0 2px 7px 2px rgba(0,0,0,0.15), 0 1px 3.5px rgba(0,0,0,0.30);
      overflow: hidden;
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 85px;
      flex-shrink: 0;
    }

    .sidebar-menu {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 0 6px;
      overflow: hidden;
    }

    .sidebar-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 6px;
      border-radius: 12px;
      cursor: pointer;
      position: relative;
      text-decoration: none;
    }

    .sidebar-item:hover { background: #f2f4f4; }

    .sidebar-item .icon-wrap {
      height: 36px;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sidebar-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #e8eaec, #ccc);
      border: 1px solid #8d959f;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      color: #576773;
      font-weight: 600;
    }

    .sidebar-label {
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 11px;
      color: #273540;
      text-align: center;
      line-height: 1.4;
      margin-top: 2px;
    }

    .sidebar-badge {
      position: absolute;
      top: 2px;
      right: 6px;
      background: #2b7abc;
      color: #fff;
      font-size: 11px;
      font-weight: 600;
      min-width: 18px;
      height: 18px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }

    .sidebar-minimize {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px 6px;
      cursor: pointer;
      flex-shrink: 0;
      border-top: 1px solid #f0f0f0;
      color: #273540;
    }

    /* ─── Main area ────────────────────────────────────────────── */
    .main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    /* ─── Top navbar ───────────────────────────────────────────── */
    .topbar-wrap {
      padding: 12px 12px 12px 0;
    }

    .topbar {
      background: #fff;
      border-radius: 16px;
      height: 66px;
      display: flex;
      align-items: center;
      padding: 0 24px;
      gap: 24px;
      border-bottom: 1px solid #e8eaec;
    }

    .topbar-left {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .icon-btn {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: transparent;
      border: none;
      flex-shrink: 0;
      color: #273540;
    }

    .icon-btn:hover { background: #f2f4f4; }

    /* Athena — gradient outline */
    .icon-btn.athena {
      position: relative;
      background: #fff;
      border: none;
      color: #3b0764;
    }
    .icon-btn.athena::before {
      content: '';
      position: absolute;
      inset: -1px;
      border-radius: 13px;
      padding: 1px;
      background: linear-gradient(195deg, #944fb3, #027887);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
    }

    /* AI spark — gradient fill (active = panel open) */
    .icon-btn.ai-spark {
      background: linear-gradient(195deg, #944fb3, #027887);
      border: none;
      color: white;
    }
    .icon-btn.ai-spark.inactive {
      background: transparent;
      position: relative;
      border: none;
      color: #944fb3;
    }
    .icon-btn.ai-spark.inactive .ai-icon-white { display: none !important; }
    .icon-btn.ai-spark.inactive .ai-icon-color { display: inline !important; }
    .icon-btn.ai-spark:not(.inactive) .ai-icon-color { display: none !important; }
    .icon-btn.ai-spark.inactive::before {
      content: '';
      position: absolute;
      inset: -1px;
      border-radius: 13px;
      padding: 1px;
      background: linear-gradient(195deg, #944fb3, #027887);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
    }

    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .bc-link {
      color: #2369a4;
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      padding: 0 4px;
    }

    .bc-sep {
      color: #576773;
      display: flex;
      align-items: center;
    }

    .bc-current {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #273540;
      font-size: 16px;
      padding: 0 4px;
    }

    /* ─── Content area ─────────────────────────────────────────── */
    .content-area {
      flex: 1;
      display: flex;
      align-items: flex-end;
      justify-content: flex-end;
      gap: 32px;
      padding: 16px;
      overflow: hidden;
    }

    /* ─── Agent shell ──────────────────────────────────────────── */
    .agent-shell-border {
      width: 480px;
      height: 100%;
      border-radius: 24px;
      padding: 1px;
      background: linear-gradient(193.87deg, #9e58bd, #00828e);
      flex-shrink: 0;
      display: flex;
    }

    .agent-shell {
      background: #fff;
      border-radius: 23px;
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Agent header */
    .agent-header {
      background: linear-gradient(193.87deg, #9e58bd 0%, #00828e 100%);
      height: 60px;
      display: flex;
      align-items: center;
      padding: 0 16px;
      flex-shrink: 0;
      color: white;
    }

    .agent-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }

    .agent-title {
      display: flex;
      align-items: center;
      gap: 8px;
      color: white;
    }

    .agent-title-text {
      font-family: 'Inclusive Sans', sans-serif;
      font-size: 20px;
      font-weight: 700;
      color: #fff;
      line-height: 1.25;
    }

    .agent-header-actions {
      display: flex;
      gap: 8px;
    }

    .agent-hdr-btn {
      width: 32px;
      height: 32px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: transparent;
      border: 1px solid rgba(255,255,255,0.5);
      color: white;
    }

    .agent-hdr-btn:hover { background: rgba(255,255,255,0.15); }
    .agent-hdr-btn.close-btn { border-color: transparent; }

    /* Agent scrollable content */
    .agent-body {
      flex: 1;
      overflow-y: auto;
      padding: 48px 24px 0;
      display: flex;
      flex-direction: column;
      gap: 32px;
    }

    .agent-body::-webkit-scrollbar { width: 4px; }
    .agent-body::-webkit-scrollbar-track { background: transparent; }
    .agent-body::-webkit-scrollbar-thumb { background: #d7dadd; border-radius: 2px; }

    /* ─── Chat history view ─────────────────────────────────────── */
    .history-body {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: none;
      flex-direction: column;
      gap: 24px;
    }

    .history-body::-webkit-scrollbar { width: 4px; }
    .history-body::-webkit-scrollbar-track { background: transparent; }
    .history-body::-webkit-scrollbar-thumb { background: #d7dadd; border-radius: 2px; }

    .history-back {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #2369a4;
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      width: fit-content;
    }

    .history-back:hover { text-decoration: underline; }

    .history-title {
      font-family: 'Inclusive Sans', sans-serif;
      font-size: 24px;
      font-weight: 700;
      color: #273540;
      line-height: 1.25;
    }

    .history-date {
      font-family: 'Inclusive Sans', sans-serif;
      font-size: 16px;
      font-weight: 600;
      color: #273540;
      line-height: 1.25;
    }

    .history-group {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .history-items {
      display: flex;
      flex-direction: column;
    }

    .history-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 12px 0;
      cursor: pointer;
    }

    .history-item-label {
      color: #2369a4;
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 16px;
      line-height: 1.5;
      flex: 1;
    }

    .history-item-label:hover { text-decoration: underline; }

    .history-item-menu {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #576773;
      flex-shrink: 0;
      border-radius: 6px;
      cursor: pointer;
      border: none;
      background: none;
    }

    .history-item-menu:hover { background: #f2f4f4; }

    .history-sep {
      height: 1px;
      background: #e8eaec;
      border: none;
    }

    /* ─── Chat flow view ────────────────────────────────────────── */
    .chat-body {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: none;
      flex-direction: column;
      gap: 24px;
    }

    .chat-body::-webkit-scrollbar { width: 4px; }
    .chat-body::-webkit-scrollbar-track { background: transparent; }
    .chat-body::-webkit-scrollbar-thumb { background: #d7dadd; border-radius: 2px; }

    /* User bubble */
    .chat-user-wrap {
      display: flex;
      justify-content: flex-end;
      padding-left: 24px;
    }

    .chat-user-bubble {
      background: #fff;
      border: 1px solid #e8eaec;
      border-radius: 16px;
      padding: 16px;
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 16px;
      color: #273540;
      line-height: 1.5;
    }

    /* Agent response */
    .chat-agent-response {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }


    .chat-agent-text {
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 16px;
      color: #273540;
      line-height: 1.5;
    }

    .chat-action-btns {
      display: flex;
      gap: 8px;
    }

    .chat-action-btn {
      width: 32px;
      height: 32px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: transparent;
      border: 1px solid #86a8d5;
      color: #576773;
    }

    .chat-action-btn:hover { background: #f0f6ff; }

    /* Suggested prompts */
    .suggested-prompts {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .suggested-prompt-btn {
      background: #d5e2f6;
      border: 1px solid #d5e2f6;
      border-radius: 12px;
      padding: 0 12px;
      height: 40px;
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 16px;
      font-weight: 600;
      color: #1d354f;
      cursor: pointer;
      white-space: nowrap;
    }

    .suggested-prompt-btn:hover { background: #c2d5f0; }

    .chat-disclaimer {
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 14px;
      color: #576773;
      line-height: 1.5;
    }

    /* Reasoning state component */
    .reasoning-wrap {
      display: flex;
      flex-direction: column;
    }

    .reasoning-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 16px;
      font-weight: 600;
      line-height: 1.5;
    }

    .reasoning-row.loading { color: #576773; cursor: default; }
    .reasoning-row.done    { color: #037d37; cursor: pointer; }

    .reasoning-spinner {
      width: 18px;
      height: 18px;
      border: 2px solid #d0d8dd;
      border-top-color: #576773;
      border-radius: 50%;
      flex-shrink: 0;
      animation: reasoning-spin 0.8s linear infinite;
    }

    @keyframes reasoning-spin { to { transform: rotate(360deg); } }

    .reasoning-chevron { transition: transform 0.2s ease; margin-left: auto; }

    .reasoning-details {
      display: none;
      padding: 10px 0 16px 16px;
    }

    .reasoning-details-inner {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding-left: 16px;
      border-left: 1px solid #8d959f;
    }

    .reasoning-text,
    .reasoning-section-label,
    .reasoning-section-value {
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 14px;
      color: #273540;
      line-height: 1.5;
    }

    .reasoning-section { display: flex; flex-direction: column; gap: 2px; }

    /* Real textarea input */
    .chat-textarea {
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 16px;
      color: #273540;
      line-height: 1.5;
      border: none;
      outline: none;
      resize: none;
      width: 100%;
      min-height: 24px;
      max-height: 120px;
      overflow-y: auto;
      background: transparent;
    }

    .chat-textarea::placeholder { color: #576773; }

    /* Greeting */
    @keyframes wave-hand {
      0%   { transform: rotate(0deg);   }
      20%  { transform: rotate(20deg);  }
      40%  { transform: rotate(-15deg); }
      60%  { transform: rotate(18deg);  }
      80%  { transform: rotate(-8deg);  }
      100% { transform: rotate(0deg);   }
    }

    .greeting-hand-wrap {
      display: inline-flex;
      flex-shrink: 0;
      transform-origin: bottom center;
    }

    .greeting-hand-wrap.waving {
      animation: wave-hand 0.7s ease-in-out;
    }

    .greeting-row {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #273540;
    }

    .greeting-name {
      font-family: 'Inclusive Sans', sans-serif;
      font-size: 28px;
      font-weight: 700;
      background: linear-gradient(90deg, #944fb3 0%, #027887 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1.25;
    }

    .greeting-sub {
      color: #576773;
      font-size: 16px;
      line-height: 1.5;
      margin-top: 4px;
    }

    /* Sections */
    .agent-section {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .section-title {
      font-family: 'Inclusive Sans', sans-serif;
      font-size: 16px;
      font-weight: 700;
      color: #273540;
      line-height: 1.25;
    }

    .section-items {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Item rows */
    .agent-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 14px 16px;
      background: #fff;
      border-radius: 16px;
      border: 1px solid #e8eaec;
      cursor: pointer;
      transition: background 0.12s;
      color: #2871af;
    }

    .agent-item:hover { background: #f9fafb; }

    .item-icon {
      width: 24px;
      height: 24px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .item-body {
      flex: 1;
      min-width: 0;
    }

    .item-title {
      font-family: 'Inclusive Sans', sans-serif;
      font-size: 16px;
      font-weight: 700;
      color: #273540;
      line-height: 1.25;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .item-desc {
      font-size: 14px;
      color: #576773;
      line-height: 1.5;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .item-pill {
      background: #fff;
      border: 1px solid #2b7abc;
      border-radius: 8px;
      padding: 4px 8px;
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 14px;
      font-weight: 600;
      color: #2b7abc;
      flex-shrink: 0;
      white-space: nowrap;
    }

    /* Agent input area */
    .agent-input-area {
      padding: 12px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex-shrink: 0;
    }

    .agent-input-box {
      background: #fff;
      border-radius: 16px;
      border: 1px solid #5f6e7a;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .input-placeholder {
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 16px;
      color: #576773;
      line-height: 1.5;
      min-height: 24px;
    }

    .input-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #576773;
    }

    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tb-btn {
      width: 32px;
      height: 32px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: transparent;
      border: 1px solid #86a8d5;
      color: #1d354f;
    }

    .tb-btn:hover { background: #f2f4f4; }

    .tb-submit {
      width: 32px;
      height: 32px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: none;
    }

    .tb-submit.send {
      background: #1d354f;
      color: white;
    }

    .tb-submit.send:hover { background: #162840; }

    /* ═══════════════════════════════════════════════════════════
       Prompt Builder Modal
    ═══════════════════════════════════════════════════════════ */

    .pb-overlay {
      position: fixed;
      inset: 0;
      background: rgba(39,53,64,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 24px;
    }

    .pb-modal {
      background: #fff;
      border-radius: 20px;
      width: 100%;
      max-width: 860px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
      position: relative;
    }

    .pb-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 24px;
      border-bottom: 1px solid #e8ebec;
      flex-shrink: 0;
    }

    .pb-modal-header-left {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #576773;
    }

    .pb-modal-title {
      font-family: 'Inclusive Sans', sans-serif;
      font-size: 17px;
      font-weight: 700;
      color: #273540;
    }

    .pb-x-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 6px;
      border-radius: 8px;
      color: #576773;
      display: flex;
      align-items: center;
      transition: background 0.15s;
    }
    .pb-x-btn:hover { background: #f2f4f5; color: #273540; }

    .pb-body {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    .pb-modal-footer {
      flex-shrink: 0;
      padding: 16px 24px;
      border-top: 1px solid #e8ebec;
      display: none;
      align-items: center;
      gap: 10px;
      background: #fff;
    }

    /* Category grid */
    .pb-category-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .pb-category-card {
      background: #fff;
      border: 1.5px solid #d0d8dd;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: border-color 0.15s, box-shadow 0.15s, transform 0.15s;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .pb-category-card:hover {
      border-color: #944fb3;
      box-shadow: 0 4px 16px rgba(148,79,179,0.12);
      transform: translateY(-1px);
    }

    .pb-cat-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: #f2f4f5;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #273540;
    }

    .pb-cat-title {
      font-family: 'Inclusive Sans', sans-serif;
      font-size: 15px;
      font-weight: 700;
      color: #273540;
      line-height: 1.25;
    }

    .pb-cat-desc {
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 13px;
      color: #576773;
      line-height: 1.5;
    }

    /* Actions view */
    .pb-actions-wrap { display: flex; flex-direction: column; gap: 20px; }

    .pb-actions-header { display: flex; align-items: center; gap: 10px; }

    .pb-back-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 6px;
      border-radius: 8px;
      color: #576773;
      display: flex;
      align-items: center;
      transition: background 0.15s;
    }
    .pb-back-btn:hover { background: #f2f4f5; color: #273540; }

    .pb-actions-title {
      font-family: 'Inclusive Sans', sans-serif;
      font-size: 17px;
      font-weight: 700;
      color: #273540;
    }

    .pb-action-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
    }

    .pb-action-btn {
      background: #fff;
      border: 1.5px solid #d0d8dd;
      border-radius: 10px;
      padding: 16px 12px;
      cursor: pointer;
      transition: border-color 0.15s, box-shadow 0.15s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 13px;
      font-weight: 600;
      color: #273540;
      text-align: center;
    }
    .pb-action-btn:hover {
      border-color: #944fb3;
      box-shadow: 0 2px 8px rgba(148,79,179,0.1);
    }

    .pb-action-icon { font-size: 22px; line-height: 1; }

    /* Result view */
    .pb-result-wrap { display: flex; flex-direction: column; gap: 16px; }

    .pb-result-header { display: flex; align-items: center; gap: 10px; }

    .pb-result-title {
      font-family: 'Inclusive Sans', sans-serif;
      font-size: 17px;
      font-weight: 700;
      color: #273540;
      flex: 1;
    }

    .pb-prompt-box {
      background: #f2f4f5;
      border: 1.5px solid #d0d8dd;
      border-radius: 10px;
      padding: 16px;
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 15px;
      color: #273540;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
      min-height: 80px;
    }
    .pb-prompt-box[contenteditable="true"] {
      border-color: #944fb3;
      outline: none;
      background: #fff;
      box-shadow: 0 0 0 3px rgba(148,79,179,0.08);
    }

    .pb-result-actions { display: flex; gap: 10px; flex-wrap: wrap; }

    .pb-result-footer {
      padding-top: 16px;
      border-top: 1px solid #e8ebec;
    }

    /* Buttons */
    .pb-btn-primary {
      background: #1d354f;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .pb-btn-primary:hover { background: #162840; }

    .pb-btn-use {
      background: linear-gradient(135deg, #944fb3, #027887);
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .pb-btn-use:hover { opacity: 0.88; }

    .pb-btn-secondary {
      background: transparent;
      color: #273540;
      border: 1.5px solid #d0d8dd;
      padding: 10px 20px;
      border-radius: 8px;
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: border-color 0.15s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .pb-btn-secondary:hover { border-color: #576773; }

    .pb-btn-ghost {
      background: transparent;
      border: none;
      color: #576773;
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 14px;
      cursor: pointer;
      padding: 4px 0;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .pb-btn-ghost:hover { color: #273540; }

    /* Inner form dialog */
    .pb-form-overlay {
      position: fixed;
      inset: 0;
      background: rgba(39,53,64,0.45);
      display: flex;
      align-items: flex-start;
      justify-content: center;
      z-index: 300;
      padding: 40px 24px;
      overflow-y: auto;
    }

    .pb-form-dialog {
      background: #fff;
      border-radius: 16px;
      width: 100%;
      max-width: 600px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.18);
      display: flex;
      flex-direction: column;
    }

    .pb-form-dialog-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 20px;
      border-bottom: 1px solid #e8ebec;
      flex-shrink: 0;
    }

    .pb-form-dialog-title {
      font-family: 'Inclusive Sans', sans-serif;
      font-size: 17px;
      font-weight: 700;
      color: #273540;
    }

    .pb-form-dialog-body {
      padding: 20px;
      overflow-y: auto;
      max-height: 65vh;
    }

    /* Form fields inside dialog */
    .pb-form-dialog .form-field { margin-bottom: 16px; }

    .pb-form-dialog .form-field label {
      display: block;
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 13px;
      font-weight: 600;
      color: #273540;
      margin-bottom: 4px;
    }

    .pb-form-dialog .form-field input,
    .pb-form-dialog .form-field textarea,
    .pb-form-dialog .form-field select {
      width: 100%;
      padding: 8px 12px;
      border: 1.5px solid #d0d8dd;
      border-radius: 8px;
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 14px;
      color: #273540;
      background: #fff;
      transition: border-color 0.15s, box-shadow 0.15s;
      outline: none;
    }
    .pb-form-dialog .form-field input:focus,
    .pb-form-dialog .form-field textarea:focus,
    .pb-form-dialog .form-field select:focus {
      border-color: #944fb3;
      box-shadow: 0 0 0 3px rgba(148,79,179,0.1);
    }

    .pb-form-dialog .help-text {
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 12px;
      color: #8d959f;
      margin-top: 4px;
    }

    .pb-form-dialog .required { color: #c0392b; }

    .pb-form-dialog .checkbox-field {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }
    .pb-form-dialog .checkbox-field label {
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 14px;
      color: #273540;
      margin-bottom: 0;
      cursor: pointer;
    }

    .pb-form-dialog .form-actions {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      padding-top: 16px;
      margin-top: 8px;
      border-top: 1px solid #e8ebec;
    }

    .pb-form-dialog .button-primary,
    .pb-modal-footer .button-primary {
      background: #1d354f;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
    }
    .pb-form-dialog .button-primary:hover,
    .pb-modal-footer .button-primary:hover { background: #162840; }
    .pb-form-dialog .button-primary:disabled,
    .pb-modal-footer .button-primary:disabled { background: #d0d8dd; cursor: not-allowed; }

    .pb-form-dialog .button-secondary,
    .pb-modal-footer .button-secondary {
      background: transparent;
      color: #273540;
      border: 1.5px solid #d0d8dd;
      padding: 10px 20px;
      border-radius: 8px;
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: border-color 0.15s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .pb-form-dialog .button-secondary:hover,
    .pb-modal-footer .button-secondary:hover { border-color: #576773; }

    .pb-form-dialog .advanced-options-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e8ebec;
    }
    .pb-form-dialog .advanced-options-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      background: transparent;
      border: none;
      color: #576773;
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      padding: 4px 0;
      width: 100%;
      justify-content: flex-start;
    }
    .pb-form-dialog .advanced-options-toggle:hover { color: #273540; }
    .pb-form-dialog .advanced-options-toggle-icon { font-size: 10px; transition: transform 0.2s; }
    .pb-form-dialog .advanced-options-toggle.expanded .advanced-options-toggle-icon { transform: rotate(90deg); }
    .pb-form-dialog .advanced-options-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .pb-form-dialog .advanced-options-content.expanded { max-height: 3000px; transition: max-height 0.5s ease-in; padding-top: 12px; }

    .pb-form-dialog .file-upload-area {
      border: 1.5px dashed #d0d8dd;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      background: #f2f4f5;
      cursor: pointer;
      transition: border-color 0.15s;
    }
    .pb-form-dialog .file-upload-area:hover { border-color: #944fb3; }
    .pb-form-dialog .file-upload-icon { font-size: 20px; margin-bottom: 4px; }
    .pb-form-dialog .file-upload-text {
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 13px;
      font-weight: 600;
      color: #273540;
    }
    .pb-form-dialog .file-upload-hint {
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 12px;
      color: #8d959f;
    }
    .pb-form-dialog .file-list { list-style: none; margin-top: 8px; }
    .pb-form-dialog .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      border: 1px solid #d0d8dd;
      border-radius: 6px;
      margin-bottom: 4px;
      background: #fff;
    }
    .pb-form-dialog .file-item-name {
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 13px;
      color: #273540;
    }
    .pb-form-dialog .file-item-size { font-size: 12px; color: #8d959f; margin-left: 6px; }
    .pb-form-dialog .file-item-remove {
      background: transparent;
      border: none;
      color: #8d959f;
      cursor: pointer;
      font-size: 16px;
      padding: 2px 4px;
    }
    .pb-form-dialog .file-item-remove:hover { color: #c0392b; }

    /* Toast */
    .pb-toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #273540;
      color: #fff;
      padding: 12px 20px;
      border-radius: 10px;
      font-family: 'Atkinson Hyperlegible Next', sans-serif;
      font-size: 14px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      z-index: 9999;
    }
  </style>
</head>
<body>
  <div class="page-wrapper">

    <!-- ── Sidebar ── -->
    <div class="sidebar">
      <div class="sidebar-card">

        <!-- Logo -->
        <div class="sidebar-logo">
          <img src="Canvas.png" alt="Canvas" style="width:40px;height:40px;object-fit:contain">
        </div>

        <!-- Nav items -->
        <div class="sidebar-menu">

          <!-- Account -->
          <div class="sidebar-item">
            <div class="icon-wrap">
              <div class="sidebar-avatar">Z</div>
            </div>
            <span class="sidebar-label">Account</span>
          </div>

          <!-- Dashboard -->
          <div class="sidebar-item" style="color:#273540">
            <div class="icon-wrap">
              <i data-lucide="layout-dashboard" style="width:24px;height:24px;stroke-width:1.5"></i>
            </div>
            <span class="sidebar-label">Dashboard</span>
          </div>

          <!-- Agent -->
          <div class="sidebar-item" style="color:#273540">
            <div class="icon-wrap">
              <i data-lucide="shield-user" style="width:24px;height:24px;stroke-width:1.5"></i>
            </div>
            <span class="sidebar-label">Agent</span>
          </div>

          <!-- Courses -->
          <div class="sidebar-item" style="color:#273540">
            <div class="icon-wrap">
              <i data-lucide="book-text" style="width:24px;height:24px;stroke-width:1.5"></i>
            </div>
            <span class="sidebar-label">Courses</span>
          </div>

          <!-- Calendar -->
          <div class="sidebar-item" style="color:#273540">
            <div class="icon-wrap">
              <i data-lucide="calendar-days" style="width:24px;height:24px;stroke-width:1.5"></i>
            </div>
            <span class="sidebar-label">Calendar</span>
          </div>

          <!-- Inbox (badge) -->
          <div class="sidebar-item" style="color:#273540">
            <span class="sidebar-badge">9</span>
            <div class="icon-wrap">
              <i data-lucide="inbox" style="width:24px;height:24px;stroke-width:1.5"></i>
            </div>
            <span class="sidebar-label">Inbox</span>
          </div>

          <!-- History -->
          <div class="sidebar-item" style="color:#273540">
            <div class="icon-wrap">
              <i data-lucide="clock" style="width:24px;height:24px;stroke-width:1.5"></i>
            </div>
            <span class="sidebar-label">History</span>
          </div>

          <!-- Help -->
          <div class="sidebar-item" style="color:#273540">
            <div class="icon-wrap">
              <i data-lucide="circle-help" style="width:24px;height:24px;stroke-width:1.5"></i>
            </div>
            <span class="sidebar-label">Help</span>
          </div>

        </div>

        <!-- Minimize -->
        <div class="sidebar-minimize">
          <i data-lucide="panel-left-close" style="width:24px;height:24px;stroke-width:2"></i>
        </div>
      </div>
    </div>

    <!-- ── Main ── -->
    <div class="main-area">

      <!-- Top navbar -->
      <div class="topbar-wrap">
        <div class="topbar">
          <div class="topbar-left">

            <!-- Hamburger -->
            <button class="icon-btn">
              <i data-lucide="menu" style="width:20px;height:20px;stroke-width:2"></i>
            </button>

            <!-- Breadcrumb -->
            <div class="breadcrumb">
              <span class="bc-link">Level 1</span>
              <span class="bc-sep">
                <i data-lucide="chevron-right" style="width:16px;height:16px;stroke-width:1.5;color:#576773"></i>
              </span>
              <span class="bc-current">Current Level</span>
            </div>
          </div>

          <div class="topbar-right">
            <!-- AI Spark button — toggles agent panel -->
            <button class="icon-btn ai-spark inactive" id="toggleAgentBtn" title="Open Ignite Agent">
              <img src="AI Icon.svg" class="ai-icon-white" style="width:20px;height:20px;object-fit:contain">
              <img src="AI Icon-color.svg" class="ai-icon-color" style="width:20px;height:20px;object-fit:contain;display:none">
            </button>
          </div>
        </div>
      </div>

      <!-- Content area (gray = page content goes here) -->
      <div class="content-area">

        <!-- ── Agent Shell ── -->
        <div class="agent-shell-border" id="agentShellBorder" style="display:none">
          <div class="agent-shell">

            <!-- Agent header (gradient) -->
            <div class="agent-header">
              <div class="agent-header-row">
                <div class="agent-title">
                  <img src="AI Icon.svg" style="width:20px;height:20px;object-fit:contain">
                  <span class="agent-title-text">Ignite Agent</span>
                </div>
                <div class="agent-header-actions">
                  <button class="agent-hdr-btn" id="composeBtn" title="New chat">
                    <i data-lucide="square-pen" style="width:16px;height:16px;stroke-width:1.5"></i>
                  </button>
                  <button class="agent-hdr-btn" id="historyBtn" title="History">
                    <i data-lucide="history" style="width:16px;height:16px;stroke-width:1.5"></i>
                  </button>
                  <button class="agent-hdr-btn close-btn" id="closeAgentBtn" title="Close">
                    <i data-lucide="x" style="width:16px;height:16px;stroke-width:2"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- Scrollable body -->
            <div class="agent-body" id="agentBody">

              <!-- Greeting -->
              <div>
                <div class="greeting-row">
                  <span class="greeting-hand-wrap"><i data-lucide="hand" style="width:26px;height:26px;stroke-width:1.8;transform:rotate(-35deg)"></i></span>
                  <span class="greeting-name">Hello, Zoe!</span>
                </div>
                <div class="greeting-sub">What are we doing today?</div>
              </div>

              <!-- Get started -->
              <div class="agent-section">
                <div class="section-title">Get started</div>
                <div class="section-items">

                  <div class="agent-item" id="promptBuilderItem" style="cursor:pointer">
                    <div class="item-icon">
                      <i data-lucide="wand-2" style="width:24px;height:24px;stroke-width:2"></i>
                    </div>
                    <div class="item-body">
                      <div class="item-title">Prompt builder</div>
                      <div class="item-desc">Generate common prompts</div>
                    </div>
                    <div class="item-pill">Start here</div>
                  </div>

                  <div class="agent-item">
                    <div class="item-icon">
                      <i data-lucide="library-big" style="width:24px;height:24px;stroke-width:2"></i>
                    </div>
                    <div class="item-body">
                      <div class="item-title">Community library</div>
                      <div class="item-desc">Browse and contribute community prompts</div>
                    </div>
                  </div>

                  <div class="agent-item">
                    <div class="item-icon">
                      <i data-lucide="bookmark" style="width:24px;height:24px;stroke-width:2"></i>
                    </div>
                    <div class="item-body">
                      <div class="item-title">Saved prompts</div>
                      <div class="item-desc">Re-use and share your favorite prompts</div>
                    </div>
                  </div>

                </div>
              </div>

              <!-- History -->
              <div class="agent-section">
                <div class="section-title">History</div>
                <div class="section-items">

                  <div class="agent-item" style="cursor:pointer" onclick="setView('history')">
                    <div class="item-icon">
                      <i data-lucide="history" style="width:24px;height:24px;stroke-width:2"></i>
                    </div>
                    <div class="item-body">
                      <div class="item-title">Chats</div>
                      <div class="item-desc">Access previous agent conversations</div>
                    </div>
                  </div>

                  <!-- <div class="agent-item">
                    <div class="item-icon">
                      <i data-lucide="file-box" style="width:24px;height:24px;stroke-width:2"></i>
                    </div>
                    <div class="item-body">
                      <div class="item-title">Artifacts</div>
                      <div class="item-desc">Retrieve previously generated content</div>
                    </div>
                  </div> -->

                </div>
              </div>

              <!-- Specialized agents -->
              <div class="agent-section" style="padding-bottom:8px">
                <div class="section-title">Specialized agents</div>
                <div class="section-items">

                  <!-- <div class="agent-item" style="color:#3b0764">
                    <div class="item-icon">
                      <i data-lucide="graduation-cap" style="width:24px;height:24px;stroke-width:2"></i>
                    </div>
                    <div class="item-body">
                      <div class="item-title">Study with Athena</div>
                      <div class="item-desc">Chat with a study coach for learners</div>
                    </div>
                  </div> -->

                  <div class="agent-item" style="color:#576773">
                    <div class="item-icon">
                      <i data-lucide="bot" style="width:24px;height:24px;stroke-width:2"></i>
                    </div>
                    <div class="item-body">
                      <div class="item-title">PandaBot</div>
                      <div class="item-desc">Ask questions and get support for Canvas</div>
                    </div>
                  </div>

                </div>
              </div>

            </div><!-- /agent-body -->

            <!-- ── Chat History view ── -->
            <div class="history-body" id="historyBody">

              <div style="display:flex;flex-direction:column;gap:16px">
                <button class="history-back" id="backBtn">
                  <i data-lucide="chevron-left" style="width:12px;height:12px;stroke-width:1.5"></i>
                  Back
                </button>
                <h2 class="history-title">Chat History</h2>
              </div>

              <!-- 12/31/2025 -->
              <div class="history-group">
                <div class="history-date">12/31/2025</div>
                <div class="history-items">
                  <div class="history-item">
                    <span class="history-item-label">Review geometry proofs for the Unit 4 quiz</span>
                    <button class="history-item-menu"><i data-lucide="ellipsis-vertical" style="width:16px;height:16px;stroke-width:1.5"></i></button>
                  </div>
                  <hr class="history-sep">
                  <div class="history-item">
                    <span class="history-item-label">Build a weekly study plan across classes</span>
                    <button class="history-item-menu"><i data-lucide="ellipsis-vertical" style="width:16px;height:16px;stroke-width:1.5"></i></button>
                  </div>
                  <hr class="history-sep">
                  <div class="history-item">
                    <span class="history-item-label">Get feedback on my English essay draft</span>
                    <button class="history-item-menu"><i data-lucide="ellipsis-vertical" style="width:16px;height:16px;stroke-width:1.5"></i></button>
                  </div>
                </div>
              </div>

              <!-- 12/30/2025 -->
              <div class="history-group">
                <div class="history-date">12/30/2025</div>
                <div class="history-items">
                  <div class="history-item">
                    <span class="history-item-label">Create a catch up plan for overdue work</span>
                    <button class="history-item-menu"><i data-lucide="ellipsis-vertical" style="width:16px;height:16px;stroke-width:1.5"></i></button>
                  </div>
                  <hr class="history-sep">
                  <div class="history-item">
                    <span class="history-item-label">Practice biology terms with quick flashcards</span>
                    <button class="history-item-menu"><i data-lucide="ellipsis-vertical" style="width:16px;height:16px;stroke-width:1.5"></i></button>
                  </div>
                  <hr class="history-sep">
                  <div class="history-item">
                    <span class="history-item-label">Prepare for tomorrow's chemistry lab checklist</span>
                    <button class="history-item-menu"><i data-lucide="ellipsis-vertical" style="width:16px;height:16px;stroke-width:1.5"></i></button>
                  </div>
                </div>
              </div>

            </div><!-- /history-body -->

            <!-- ── Chat Flow view ── -->
            <div class="chat-body" id="chatBody">
              <!-- messages injected by JS -->
            </div><!-- /chat-body -->

            <!-- Input area -->
            <div class="agent-input-area">
              <div class="agent-input-box">
                <textarea id="chatInput" class="chat-textarea" placeholder="Help me…" rows="1"></textarea>
                <div class="input-toolbar">
                  <div class="toolbar-left">
                    <button class="tb-btn" title="Attach">
                      <i data-lucide="plus" style="width:16px;height:16px;stroke-width:2"></i>
                    </button>
                  </div>
                  <div class="toolbar-right">
                    <button class="tb-btn" title="Prompt Builder" onclick="pbOpen()">
                      <i data-lucide="wand-2" style="width:16px;height:16px;stroke-width:1.5"></i>
                    </button>
                    <button class="tb-submit send" id="sendBtn" title="Send">
                      <i data-lucide="arrow-up" style="width:15px;height:15px;stroke-width:2.5"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>

          </div><!-- /agent-shell -->
        </div><!-- /agent-shell-border -->

      </div><!-- /content-area -->
    </div><!-- /main-area -->
  </div><!-- /page-wrapper -->

  <script src="prompts-config.js"></script>

  <!-- ── Prompt Builder Modal ──────────────────────────────────── -->
  <div id="pb-overlay" class="pb-overlay" style="display:none">
    <div class="pb-modal">
      <div class="pb-modal-header">
        <div class="pb-modal-header-left">
          <i data-lucide="wand-2" style="width:18px;height:18px;stroke-width:1.5"></i>
          <span class="pb-modal-title">Prompt Builder</span>
        </div>
        <button class="pb-x-btn" onclick="pbClose()">
          <i data-lucide="x" style="width:18px;height:18px;stroke-width:2"></i>
        </button>
      </div>
      <div id="pb-app" class="pb-body"></div>
      <div id="pb-footer" class="pb-modal-footer"></div>
    </div>
  </div>

  <!-- Toast -->
  <div id="pb-toast" class="pb-toast" style="display:none">
    <span id="pb-toast-message"></span>
  </div>

  <script>
    lucide.createIcons();

    // ── Element refs ──────────────────────────────────────────────
    const toggleBtn   = document.getElementById('toggleAgentBtn');
    const closeBtn    = document.getElementById('closeAgentBtn');
    const composeBtn  = document.getElementById('composeBtn');
    const historyBtn  = document.getElementById('historyBtn');
    const backBtn     = document.getElementById('backBtn');
    const sendBtn     = document.getElementById('sendBtn');
    const chatInput   = document.getElementById('chatInput');
    const shell       = document.getElementById('agentShellBorder');
    const agentBody   = document.getElementById('agentBody');
    const historyBody = document.getElementById('historyBody');
    const chatBody    = document.getElementById('chatBody');

    // ── Dummy response pool ───────────────────────────────────────
    const RESPONSES = [
      {
        seconds: 12,
        reasoning: 'The user is asking a general question. I checked their enrolled courses and found Biology 101, Unit 1 is the most relevant context based on upcoming assessment deadlines and syllabus weight.',
        tools: 'list_courses, listAssignments',
        sources: 'Biology 101, Unit 1, Assessment 1',
        text: 'Sure! Here\'s what I found. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Nunc sit amet velit lorem faucibus, tristique orci ut, posuere odio. Pellentesque venenatis neque ipsum, in sit amet malesuada elit egestas hendrerit. Posuere odio.',
        suggestions: ['Tell me more', 'Give me an example', 'Summarize this']
      },
      {
        seconds: 8,
        reasoning: 'I reviewed the foundational concept definitions across all units and cross-referenced them with the student\'s recent quiz performance to identify the highest-leverage areas to focus on.',
        tools: 'getStudentProgress, listConcepts',
        sources: 'Biology 101, Unit 1, Quiz 2',
        text: 'Great question! The key things to consider are: first, reviewing the foundational concepts, then practicing them in different contexts. Finally, test your understanding with a few exercises to make sure it all sticks.',
        suggestions: ['What are the key concepts?', 'Show me an example', 'Create a quiz for me']
      },
      {
        seconds: 19,
        reasoning: 'This required pulling context from multiple units and comparing the student\'s prior responses. I identified the core principle underlying the topic by analyzing patterns in assignment feedback across the semester.',
        tools: 'listAssignments, getFeedback, searchSyllabus',
        sources: 'Biology 101, Units 1–3, Assignment Feedback',
        text: 'Here\'s a thoughtful answer. The most important thing to understand is the underlying principle at work. Once you grasp that, the rest follows naturally. Let me know if you\'d like me to go deeper on any particular aspect of this topic.',
        suggestions: ['Go deeper on this', 'What are the next steps?', 'Explain it differently']
      },
      {
        seconds: 5,
        reasoning: 'The student\'s goal is clear. I queried the course roadmap and mapped the remaining milestones to a weekly schedule that aligns with assessment dates.',
        tools: 'getCourseRoadmap',
        sources: 'Biology 101, Course Schedule',
        text: 'Absolutely! Let me break it down step by step. First, identify your main goal. Second, gather the resources you need. Third, create a structured plan and timeline. Finally, execute and adjust as you go. Does that help clarify things?',
        suggestions: ['Help me create a plan', 'What resources do I need?', 'Start a new topic']
      }
    ];
    let responseIndex = 0;

    // ── View management ───────────────────────────────────────────
    function setView(view) {
      agentBody.style.display  = view === 'home'    ? 'flex' : 'none';
      historyBody.style.display = view === 'history' ? 'flex' : 'none';
      chatBody.style.display   = view === 'chat'    ? 'flex' : 'none';
      historyBtn.style.background = view === 'history' ? 'rgba(255,255,255,0.2)' : '';
      if (view === 'home') waveHand();
    }

    function waveHand() {
      const hand = document.querySelector('.greeting-hand-wrap');
      if (!hand) return;
      hand.classList.remove('waving');
      void hand.offsetWidth; // restart animation if already playing
      hand.classList.add('waving');
      hand.addEventListener('animationend', () => hand.classList.remove('waving'), { once: true });
    }

    function openAgent() {
      shell.style.display = 'flex';
      toggleBtn.classList.remove('inactive');
      waveHand();
    }

    function closeAgent() {
      shell.style.display = 'none';
      toggleBtn.classList.add('inactive');
      setView('home');
    }

    // ── Auto-grow textarea ────────────────────────────────────────
    chatInput.addEventListener('input', () => {
      chatInput.style.height = 'auto';
      chatInput.style.height = chatInput.scrollHeight + 'px';
    });

    // ── Send message ──────────────────────────────────────────────
    function sendMessage() {
      const text = chatInput.value.trim();
      if (!text) return;

      // Switch to chat view
      setView('chat');
      openAgent();

      // Clear input
      chatInput.value = '';
      chatInput.style.height = 'auto';

      // Append user bubble
      appendUserMessage(text);

      // Append thinking indicator then resolve to response
      const thinkingEl = appendThinking();
      const response = RESPONSES[responseIndex % RESPONSES.length];
      responseIndex++;

      setTimeout(() => {
        thinkingEl.remove();
        appendAgentResponse(response);
        // re-init icons for newly added elements
        lucide.createIcons({ nodes: [chatBody] });
        chatBody.scrollTop = chatBody.scrollHeight;
      }, 1800);

      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function appendUserMessage(text) {
      const wrap = document.createElement('div');
      wrap.className = 'chat-user-wrap';
      wrap.innerHTML = `<div class="chat-user-bubble">${escapeHtml(text)}</div>`;
      chatBody.appendChild(wrap);
    }

    function appendThinking() {
      const el = document.createElement('div');
      el.className = 'chat-agent-response';
      el.innerHTML = `
        <div class="reasoning-wrap">
          <div class="reasoning-row loading">
            <div class="reasoning-spinner"></div>
            <span>Analyzing request…</span>
          </div>
        </div>`;
      chatBody.appendChild(el);
      chatBody.scrollTop = chatBody.scrollHeight;
      return el;
    }

    function toggleReasoning(row) {
      const details = row.nextElementSibling;
      const chevron = row.querySelector('.reasoning-chevron');
      const isOpen = details.style.display === 'block';
      details.style.display = isOpen ? 'none' : 'block';
      chevron.style.transform = isOpen ? '' : 'rotate(90deg)';
    }

    function appendAgentResponse(response) {
      // Remove old suggested-prompts + disclaimer if present
      chatBody.querySelectorAll('.suggested-prompts, .chat-disclaimer').forEach(el => el.remove());

      const toolsHtml = response.tools ? `
          <div class="reasoning-section">
            <span class="reasoning-section-label">Tools</span>
            <span class="reasoning-section-value">${escapeHtml(response.tools)}</span>
          </div>` : '';
      const sourcesHtml = response.sources ? `
          <div class="reasoning-section">
            <span class="reasoning-section-label">Sources</span>
            <span class="reasoning-section-value">${escapeHtml(response.sources)}</span>
          </div>` : '';

      const el = document.createElement('div');
      el.className = 'chat-agent-response';
      el.innerHTML = `
        <div class="reasoning-wrap">
          <div class="reasoning-row done" onclick="toggleReasoning(this)">
            <i data-lucide="circle-check-big" style="width:20px;height:20px;stroke-width:1.5;color:#037d37;flex-shrink:0"></i>
            <span>Analyzed request</span>
            <i data-lucide="chevron-right" class="reasoning-chevron" style="width:16px;height:16px;stroke-width:1.5;color:#037d37"></i>
          </div>
          <div class="reasoning-details">
            <div class="reasoning-details-inner">
              <p class="reasoning-text">${escapeHtml(response.reasoning)}</p>
              ${toolsHtml}
              ${sourcesHtml}
            </div>
          </div>
        </div>
        <div class="chat-agent-text">${escapeHtml(response.text)}</div>
        <div class="chat-action-btns">
          <button class="chat-action-btn" title="Copy">
            <i data-lucide="copy" style="width:14px;height:14px;stroke-width:1.5"></i>
          </button>
          <button class="chat-action-btn" title="Good response">
            <i data-lucide="thumbs-up" style="width:14px;height:14px;stroke-width:1.5"></i>
          </button>
          <button class="chat-action-btn" title="Bad response">
            <i data-lucide="thumbs-down" style="width:14px;height:14px;stroke-width:1.5"></i>
          </button>
        </div>`;
      chatBody.appendChild(el);

      // Suggested prompts footer
      const footer = document.createElement('div');
      footer.innerHTML = `
        <div class="suggested-prompts">
          ${response.suggestions.map(s => `<button class="suggested-prompt-btn">${escapeHtml(s)}</button>`).join('')}
        </div>
        <p class="chat-disclaimer" style="margin-top:8px">AI can make mistakes. Consider checking important information.</p>`;
      chatBody.appendChild(footer);

      // Clicking a suggested prompt fills the input
      footer.querySelectorAll('.suggested-prompt-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          chatInput.value = btn.textContent;
          chatInput.focus();
          chatInput.dispatchEvent(new Event('input'));
        });
      });
    }

    function escapeHtml(str) {
      return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // ── Event wiring ──────────────────────────────────────────────
    toggleBtn.addEventListener('click', () => {
      shell.style.display === 'none' ? openAgent() : closeAgent();
    });

    document.querySelector('.greeting-hand-wrap')?.addEventListener('mouseenter', waveHand);

    closeBtn.addEventListener('click', closeAgent);
    composeBtn.addEventListener('click', () => {
      chatBody.innerHTML = '';
      responseIndex = 0;
      setView('home');
    });
    historyBtn.addEventListener('click', () => setView('history'));
    backBtn.addEventListener('click', () => setView('home'));
    sendBtn.addEventListener('click', sendMessage);

    chatInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // ═══════════════════════════════════════════════════════════
    // PROMPT BUILDER — inlined from sample-data.js, prompts-config.js, app.js
    // ═══════════════════════════════════════════════════════════

    const SAMPLE_DATA = {
      terms: [
        { value: 'SPRING-2026', label: 'Spring 2026' },
        { value: 'FALL-2025',   label: 'Fall 2025'   },
        { value: 'SUMMER-2026', label: 'Summer 2026' },
        { value: 'WINTER-2026', label: 'Winter 2026' }
      ],
      courses: [
        { id: '1698972', name: 'PSY1012 General Psychology',        term: 'SPRING-2026' },
        { id: '1712556', name: 'Financial Literacy 101',            term: 'SPRING-2026' },
        { id: '1712089', name: 'SPAN 502 - Advanced Spanish',       term: 'SPRING-2026' },
        { id: '1728717', name: 'Introduction to Philosophy',        term: 'SPRING-2026' },
        { id: '1733177', name: 'MATH-1010-020-Spring 2026',         term: 'SPRING-2026' },
        { id: '2001234', name: 'BIO-101-Spring 2026',               term: 'SPRING-2026' },
        { id: '2001235', name: 'CHEM-101-Spring 2026',              term: 'SPRING-2026' },
        { id: '2001236', name: 'ENG-101-Spring 2026',               term: 'SPRING-2026' },
        { id: '2001237', name: 'HIST-101-Spring 2026',              term: 'SPRING-2026' },
        { id: '2001238', name: 'CS-101-Spring 2026',                term: 'SPRING-2026' },
        { id: '1650123', name: 'Introduction to Linguistics',       term: 'FALL-2025'   },
        { id: '1650124', name: 'Principles of Teaching & Learning', term: 'FALL-2025'   },
        { id: '1650125', name: 'BIB1520 - Biblical Studies',        term: 'FALL-2025'   },
        { id: '1650127', name: 'Biology 101',                       term: 'FALL-2025'   },
        { id: '1650129', name: 'English 101',                       term: 'FALL-2025'   },
        { id: '2100001', name: 'Summer Biology Intensive',          term: 'SUMMER-2026' },
        { id: '2100003', name: 'Summer Writing Workshop',           term: 'SUMMER-2026' },
        { id: '2200001', name: 'Winter Term Special Topics',        term: 'WINTER-2026' }
      ],
      getCoursesByTerm(t) { return t ? this.courses.filter(c => c.term === t) : this.courses; },
      getCourseByName(n)  { return this.courses.find(c => c.name === n); }
    };

    // prompts-config.js is loaded from external file — reference PROMPTS_CONFIG directly

    // ── Prompt Builder State ──────────────────────────────────────
    const PbState = {
      currentView: 'categories',
      selectedCategory: null,
      selectedAction: null,
      formData: {},
      generatedPrompt: null,

      setState(updates) { Object.assign(this, updates); this.render(); },

      reset() {
        this.currentView = 'categories';
        this.selectedCategory = null;
        this.selectedAction = null;
        this.formData = {};
        this.generatedPrompt = null;
        this.render();
      },

      render() {
        const app = document.getElementById('pb-app');
        const footer = document.getElementById('pb-footer');
        if (!app) return;
        if (footer) { footer.innerHTML = ''; footer.style.display = 'none'; }
        switch (this.currentView) {
          case 'categories': app.innerHTML = pbRenderCategories(); break;
          case 'actions':    app.innerHTML = pbRenderActions(this.selectedCategory); break;
          case 'form':       pbRenderForm(this.selectedAction); break;
          case 'result':
            app.innerHTML = pbRenderResult(this.generatedPrompt);
            if (footer) {
              footer.innerHTML = `
                <button class="pb-btn-ghost" id="pb-start-over">
                  <i data-lucide="rotate-ccw" style="width:14px;height:14px;stroke-width:1.5"></i> Create another prompt
                </button>
                <div style="display:flex;gap:10px;margin-left:auto">
                  <button class="pb-btn-secondary" id="pb-copy-prompt">
                    <i data-lucide="copy" style="width:14px;height:14px;stroke-width:1.5"></i> Copy
                  </button>
                  <button class="pb-btn-use" id="pb-use-prompt">
                    <i data-lucide="send" style="width:14px;height:14px;stroke-width:1.5"></i> Send to Agent
                  </button>
                </div>`;
              footer.style.display = 'flex';
              lucide.createIcons({ nodes: [footer] });
            }
            break;
        }
        lucide.createIcons({ nodes: [app] });
      }
    };

    // ── Category icon mapping ──────────────────────────────────────
    const PB_CAT_ICONS = {
      'create':            'pencil',
      'manage':            'bar-chart-2',
      'student-management':'users',
      'course-analysis':   'search'
    };

    // ── Render functions ──────────────────────────────────────────
    function pbRenderCategories() {
      const cards = PROMPTS_CONFIG.categories.map(c => `
        <div class="pb-category-card" data-category="${c.id}">
          <div class="pb-cat-icon">
            <i data-lucide="${PB_CAT_ICONS[c.id] || 'layers'}" style="width:20px;height:20px;stroke-width:1.5"></i>
          </div>
          <div class="pb-cat-title">${c.title}</div>
          <div class="pb-cat-desc">${c.description}</div>
        </div>`).join('');
      return `<div class="pb-category-grid">${cards}</div>`;
    }

    function pbRenderActions(categoryId) {
      const cat = PROMPTS_CONFIG.categories.find(c => c.id === categoryId);
      const actions = PROMPTS_CONFIG.actions.filter(a => a.category === categoryId);
      const btns = actions.map(a => `
        <button class="pb-action-btn" data-action="${a.id}">
          <span class="pb-action-icon"><i data-lucide="${a.icon}" style="width:22px;height:22px;stroke-width:1.5"></i></span>
          <span>${a.title}</span>
        </button>`).join('');
      return `
        <div class="pb-actions-wrap">
          <div class="pb-actions-header">
            <button class="pb-back-btn" id="pb-back-to-categories">
              <i data-lucide="arrow-left" style="width:18px;height:18px;stroke-width:2"></i>
            </button>
            <span class="pb-actions-title">${cat.title}</span>
          </div>
          <div class="pb-action-grid">${btns}</div>
        </div>`;
    }

    function pbRenderForm(actionId) {
      const action = PROMPTS_CONFIG.actions.find(a => a.id === actionId);
      const app = document.getElementById('pb-app');

      // Inline wrapper reuses pb-form-dialog CSS scope for field styles
      const wrap = document.createElement('div');
      wrap.className = 'pb-form-dialog';
      wrap.style.cssText = 'background:transparent;box-shadow:none;border-radius:0;max-height:none;max-width:none;width:100%;';

      const header = document.createElement('div');
      header.className = 'pb-actions-header';
      header.style.marginBottom = '16px';
      header.innerHTML = `
        <button class="pb-back-btn" id="pb-back-to-actions">
          <i data-lucide="arrow-left" style="width:18px;height:18px;stroke-width:2"></i>
        </button>
        <span class="pb-actions-title">${action.title}</span>`;

      const formBuilder = new PbFormBuilder(action);
      const form = formBuilder.build();

      // Move form actions to modal footer
      const formActions = form.querySelector('.form-actions');
      if (formActions) formActions.remove();

      wrap.appendChild(header);
      wrap.appendChild(form);
      app.innerHTML = '';
      app.appendChild(wrap);
      lucide.createIcons({ nodes: [app] });

      const footer = document.getElementById('pb-footer');
      if (footer) {
        footer.innerHTML = `<button type="submit" form="pb-prompt-form" class="button-primary">Generate Prompt</button>`;
        footer.style.display = 'flex';
        footer.style.justifyContent = 'flex-end';
      }

      new PbConditionalFieldHandler(form);
      new PbCourseFilterHandler(form);
    }

    function pbRenderResult(prompt) {
      return `
        <div class="pb-result-wrap">
          <div class="pb-result-header">
            <button class="pb-back-btn" id="pb-back-to-categories-from-result">
              <i data-lucide="arrow-left" style="width:18px;height:18px;stroke-width:2"></i>
            </button>
            <span class="pb-result-title">Generated Prompt</span>
            <button class="pb-btn-secondary" id="pb-edit-prompt" style="padding:6px 12px;font-size:13px">Edit</button>
          </div>
          <div class="pb-prompt-box" id="pb-prompt-text" contenteditable="false">${prompt}</div>
        </div>`;
    }

    // ── Form Builder (renamed class to avoid conflict) ────────────
    class PbFormBuilder {
      constructor(actionConfig) { this.config = actionConfig; }

      build() {
        const form = document.createElement('form');
        form.id = 'pb-prompt-form';
        form.onsubmit = (e) => { e.preventDefault(); pbHandleFormSubmit(); };

        const basicFields    = this.config.formFields.filter(f => !f.advanced && f.name !== 'additionalInstructions');
        const advancedFields = this.config.formFields.filter(f =>  f.advanced && f.name !== 'additionalInstructions');
        const addlField      = this.config.formFields.find(f => f.name === 'additionalInstructions');

        basicFields.forEach(f => form.appendChild(this.createField(f)));

        if (addlField) form.appendChild(this.createField(addlField));

        if (advancedFields.length > 0) {
          const section = document.createElement('div');
          section.className = 'advanced-options-section';
          const toggle = document.createElement('button');
          toggle.type = 'button';
          toggle.className = 'advanced-options-toggle';
          toggle.innerHTML = `<span class="advanced-options-toggle-icon">▶</span><span>Advanced Options</span>`;
          const content = document.createElement('div');
          content.className = 'advanced-options-content';
          advancedFields.forEach(f => {
            const el = this.createField(f);
            el.classList.add('advanced-field');
            content.appendChild(el);
          });
          toggle.addEventListener('click', () => {
            toggle.classList.toggle('expanded');
            content.classList.toggle('expanded');
          });
          section.appendChild(toggle);
          section.appendChild(content);
          form.appendChild(section);
        }

        const actions = document.createElement('div');
        actions.className = 'form-actions';
        actions.style.justifyContent = 'flex-end';
        actions.innerHTML = `<button type="submit" class="button-primary">Generate Prompt</button>`;
        form.appendChild(actions);
        return form;
      }

      createField(fc) {
        if (fc.fieldType === 'checkbox') return this.createCheckboxField(fc);
        const wrap = document.createElement('div');
        wrap.className = 'form-field';
        if (fc.conditional) { wrap.dataset.conditional = JSON.stringify(fc.conditional); wrap.style.display = 'none'; }
        wrap.appendChild(this.createLabel(fc));
        wrap.appendChild(this.createInput(fc));
        if (fc.helpText) { const p = document.createElement('p'); p.className = 'help-text'; p.textContent = fc.helpText; wrap.appendChild(p); }
        return wrap;
      }

      createCheckboxField(fc) {
        const wrap = document.createElement('div');
        wrap.className = 'checkbox-field';
        if (fc.conditional) { wrap.dataset.conditional = JSON.stringify(fc.conditional); wrap.style.display = 'none'; }
        const input = document.createElement('input');
        input.type = 'checkbox'; input.id = fc.name; input.name = fc.name;
        if (fc.default) input.checked = true;
        const label = document.createElement('label');
        label.setAttribute('for', fc.name); label.textContent = fc.label;
        wrap.appendChild(input); wrap.appendChild(label);
        if (fc.helpText) { const p = document.createElement('p'); p.className = 'help-text'; p.textContent = fc.helpText; wrap.appendChild(p); }
        return wrap;
      }

      createLabel(fc) {
        const label = document.createElement('label');
        label.setAttribute('for', fc.name); label.textContent = fc.label;
        if (fc.required) { const s = document.createElement('span'); s.className = 'required'; s.textContent = ' *'; label.appendChild(s); }
        return label;
      }

      createInput(fc) {
        switch (fc.fieldType) {
          case 'textarea':    return this.createTextarea(fc);
          case 'select':      return this.createSelect(fc);
          case 'term-select': return this.createTermSelect(fc);
          case 'course-select': return this.createCourseSelect(fc);
          case 'file-upload': return this.createFileUpload(fc);
          default:            return this.createTextInput(fc);
        }
      }

      createTextInput(fc) {
        const input = document.createElement('input');
        input.type = fc.fieldType === 'number' ? 'number' : fc.fieldType === 'datetime-local' ? 'datetime-local' : 'text';
        input.id = fc.name; input.name = fc.name; input.placeholder = fc.placeholder || '';
        if (fc.required) input.required = true;
        if (fc.min !== undefined) input.min = fc.min;
        if (fc.max !== undefined) input.max = fc.max;
        if (fc.defaultValue !== undefined) input.value = fc.defaultValue;
        return input;
      }

      createTextarea(fc) {
        const ta = document.createElement('textarea');
        ta.id = fc.name; ta.name = fc.name; ta.placeholder = fc.placeholder || ''; ta.rows = fc.rows || 3;
        if (fc.required) ta.required = true;
        if (fc.defaultValue !== undefined) ta.value = fc.defaultValue;
        return ta;
      }

      createSelect(fc) {
        const sel = document.createElement('select');
        sel.id = fc.name; sel.name = fc.name;
        if (fc.required) sel.required = true;
        fc.options.forEach(o => {
          const opt = document.createElement('option');
          opt.value = o.value; opt.textContent = o.label;
          if (fc.defaultValue && o.value === fc.defaultValue) opt.selected = true;
          sel.appendChild(opt);
        });
        return sel;
      }

      createTermSelect(fc) {
        const sel = document.createElement('select');
        sel.id = fc.name; sel.name = fc.name; sel.className = 'term-select';
        if (fc.required) sel.required = true;
        const empty = document.createElement('option'); empty.value = ''; empty.textContent = 'Select a term'; sel.appendChild(empty);
        SAMPLE_DATA.terms.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t.value; opt.textContent = t.label;
          if (fc.defaultValue && t.value === fc.defaultValue) opt.selected = true;
          sel.appendChild(opt);
        });
        return sel;
      }

      createCourseSelect(fc) {
        const sel = document.createElement('select');
        sel.id = fc.name; sel.name = fc.name; sel.className = 'course-select';
        if (fc.required) sel.required = true;
        const empty = document.createElement('option'); empty.value = ''; empty.textContent = '-- Select a course --'; sel.appendChild(empty);
        SAMPLE_DATA.courses.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.name; opt.textContent = c.name; opt.setAttribute('data-term', c.term);
          if (fc.defaultValue && c.name === fc.defaultValue) opt.selected = true;
          sel.appendChild(opt);
        });
        return sel;
      }

      createFileUpload(fc) {
        const container = document.createElement('div');
        container.className = 'file-upload-container';
        const fileInput = document.createElement('input');
        fileInput.type = 'file'; fileInput.id = fc.name; fileInput.name = fc.name;
        fileInput.className = 'file-upload-input'; fileInput.multiple = true;
        if (fc.accept) fileInput.accept = fc.accept;
        const dropArea = document.createElement('div');
        dropArea.className = 'file-upload-area';
        dropArea.innerHTML = `<div class="file-upload-icon">📎</div><div class="file-upload-text">Drop files here or click to browse</div><div class="file-upload-hint">${fc.helpText || ''}</div>`;
        const fileList = document.createElement('ul');
        fileList.className = 'file-list'; fileList.style.display = 'none';
        const filesData = [];
        dropArea.addEventListener('click', () => fileInput.click());
        ['dragenter','dragover','dragleave','drop'].forEach(ev => dropArea.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); }));
        ['dragenter','dragover'].forEach(ev => dropArea.addEventListener(ev, () => dropArea.classList.add('drag-over')));
        ['dragleave','drop'].forEach(ev => dropArea.addEventListener(ev, () => dropArea.classList.remove('drag-over')));
        dropArea.addEventListener('drop', e => handlePbFiles(e.dataTransfer.files));
        fileInput.addEventListener('change', e => handlePbFiles(e.target.files));
        const handlePbFiles = (files) => {
          filesData.length = 0; fileList.innerHTML = '';
          if (!files.length) { fileList.style.display = 'none'; return; }
          fileList.style.display = 'block';
          Array.from(files).forEach((file, i) => {
            filesData.push({ name: file.name, size: file.size });
            const li = document.createElement('li'); li.className = 'file-item';
            const sz = file.size < 1024 ? file.size + ' B' : file.size < 1048576 ? Math.round(file.size/1024) + ' KB' : Math.round(file.size/1048576*10)/10 + ' MB';
            li.innerHTML = `<div class="file-item-info"><span class="file-item-name">${file.name}</span><span class="file-item-size">(${sz})</span></div><button type="button" class="file-item-remove" data-index="${i}">×</button>`;
            li.querySelector('.file-item-remove').addEventListener('click', function() { filesData.splice(+this.dataset.index, 1); handlePbFiles(new DataTransfer().files); });
            fileList.appendChild(li);
          });
          let hidden = container.querySelector(`input[name="${fc.name}-data"]`);
          if (!hidden) { hidden = document.createElement('input'); hidden.type = 'hidden'; hidden.name = `${fc.name}-data`; container.appendChild(hidden); }
          hidden.value = JSON.stringify(filesData);
        };
        container.appendChild(fileInput); container.appendChild(dropArea); container.appendChild(fileList);
        return container;
      }
    }

    // ── Conditional field handler ─────────────────────────────────
    class PbConditionalFieldHandler {
      constructor(form) {
        this.form = form;
        this.conditionalFields = Array.from(form.querySelectorAll('[data-conditional]')).map(el => ({ element: el, condition: JSON.parse(el.dataset.conditional) }));
        this.conditionalFields.forEach(({ condition }) => {
          const trigger = form.querySelector(`[name="${condition.field}"]`);
          if (trigger) { trigger.addEventListener('change', () => this.evaluate()); trigger.addEventListener('input', () => this.evaluate()); }
        });
        this.evaluate();
      }
      evaluate() {
        this.conditionalFields.forEach(({ element, condition }) => {
          const trigger = this.form.querySelector(`[name="${condition.field}"]`);
          const val = trigger ? (trigger.type === 'checkbox' ? trigger.checked : trigger.value) : null;
          const met = typeof condition.value === 'boolean' ? val === condition.value : val == condition.value;
          element.style.display = met ? (element.classList.contains('checkbox-field') ? 'flex' : 'block') : 'none';
        });
      }
    }

    // ── Course filter handler ─────────────────────────────────────
    class PbCourseFilterHandler {
      constructor(form) {
        this.form = form;
        this.termSel = form.querySelector('.term-select');
        this.courseSels = form.querySelectorAll('.course-select');
        if (this.termSel && this.courseSels.length) this.termSel.addEventListener('change', () => this.filter());
      }
      filter() {
        const term = this.termSel.value;
        this.courseSels.forEach(sel => {
          const prev = sel.value;
          sel.innerHTML = '<option value="">-- Select a course --</option>';
          const courses = SAMPLE_DATA.getCoursesByTerm(term);
          courses.forEach(c => { const opt = document.createElement('option'); opt.value = c.name; opt.textContent = c.name; opt.dataset.term = c.term; sel.appendChild(opt); });
          if (courses.some(c => c.name === prev)) sel.value = prev;
        });
      }
    }

    // ── Prompt generator ──────────────────────────────────────────
    class PbPromptGenerator {
      constructor(config) { this.config = config; }

      generate(formData) {
        let prompt = this.config.promptTemplate;
        const processed = this.preprocess(formData);
        const ruleKeys = this.config.templateRules ? Object.keys(this.config.templateRules) : [];

        Object.keys(processed).forEach(key => {
          if (ruleKeys.includes(key)) return;
          const v = processed[key];
          if (v != null && v !== '') {
            const formatted = (v instanceof Date || key.includes('Date')) ? this.fmtDate(v) : v;
            prompt = prompt.replace(new RegExp(`\\{${key}\\}`, 'g'), formatted);
          }
        });

        if (this.config.templateRules) {
          Object.keys(this.config.templateRules).forEach(key => {
            const rule = this.config.templateRules[key];
            const fv = processed[rule.field || key];
            let replacement = '';
            if (this.shouldInclude(rule, fv, processed)) replacement = this.applyTemplate(rule.template, processed);
            prompt = prompt.replace(new RegExp(`\\{${key}\\}`, 'g'), replacement);
          });
        }

        return prompt.replace(/\s+/g,' ').replace(/\s+\./g,'.').replace(/\s+,/g,',').replace(/,\s*,/g,',').replace(/\.\./g,'.').replace(/,\s*\./g,'.').trim();
      }

      preprocess(fd) {
        const p = {...fd};
        if (p.term) { const map = {'SPRING-2026':'Spring 2026','FALL-2025':'Fall 2025','SUMMER-2026':'Summer 2026','WINTER-2026':'Winter 2026'}; p.termFormatted = map[p.term] || p.term; }
        if (p.recipientType === 'all') p.recipientDescription = 'all students';
        else if (p.recipientType === 'criteria' && p.criteriaDescription) p.recipientDescription = p.criteriaDescription;
        else if (p.recipientType === 'specific' && p.studentNames) p.recipientDescription = `these specific students: ${p.studentNames}`;
        else if (p.recipientType) p.recipientDescription = 'students';
        Object.keys(p).forEach(k => { if (Array.isArray(p[k]) && p[k].length && p[k][0].name) p[`${k}List`] = p[k].map(f=>f.name).join(', '); });
        return p;
      }

      shouldInclude(rule, fv, fd) {
        switch (rule.condition) {
          case 'notEmpty': return fv && fv !== '' && fv != null;
          case 'true':     return fv === true || fv === 'true';
          case 'false':    return fv === false || fv === 'false';
          case 'useQuestionBank': return fd.useQuestionBank === true;
          case 'conditionalAccess': return fd.conditionalAccess === true;
          default: return typeof rule.condition === 'function' ? rule.condition(fd) : true;
        }
      }

      applyTemplate(tmpl, fd) {
        let r = tmpl;
        Object.keys(fd).forEach(k => { const v = fd[k]; if (v != null && v !== '') r = r.replace(new RegExp(`\\{${k}\\}`,'g'), (v instanceof Date || k.includes('Date')) ? this.fmtDate(v) : v); });
        return r;
      }

      fmtDate(v) {
        if (!v) return '';
        if (typeof v === 'string' && v.includes('T')) return new Date(v).toLocaleString('en-US',{month:'long',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit',hour12:true});
        return v;
      }
    }

    // ── Form submit handler ───────────────────────────────────────
    function pbHandleFormSubmit() {
      const form = document.getElementById('pb-prompt-form');
      const fd = new FormData(form);
      const data = {};
      for (let [k, v] of fd.entries()) { if (!k.endsWith('-data')) data[k] = v; }
      form.querySelectorAll('input[type="checkbox"]').forEach(cb => { data[cb.name] = cb.checked; });
      form.querySelectorAll('input[name$="-data"]').forEach(inp => {
        const fn = inp.name.replace('-data','');
        if (inp.value) { try { const files = JSON.parse(inp.value); if (files.length) data[fn] = files; } catch(e){} }
      });
      PbState.formData = data;
      const action = PROMPTS_CONFIG.actions.find(a => a.id === PbState.selectedAction);
      const prompt = new PbPromptGenerator(action).generate(data);
      pbCloseForm();
      PbState.setState({ currentView: 'result', generatedPrompt: prompt });
    }

    // ── Modal helpers ─────────────────────────────────────────────
    function pbClose() {
      document.getElementById('pb-overlay').style.display = 'none';
      PbState.reset();
    }

    function pbCloseForm() {
      PbState.setState({ currentView: 'actions' });
    }

    function pbShowToast(msg) {
      const toast = document.getElementById('pb-toast');
      document.getElementById('pb-toast-message').textContent = msg;
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 2800);
    }

    function pbUsePrompt(text) {
      chatInput.value = text;
      chatInput.style.height = 'auto';
      chatInput.style.height = chatInput.scrollHeight + 'px';
      pbClose();
      openAgent();
      sendMessage();
    }

    // ── Open prompt builder ───────────────────────────────────────
    function pbOpen() {
      PbState.reset();
      document.getElementById('pb-overlay').style.display = 'flex';
      lucide.createIcons({ nodes: [document.getElementById('pb-overlay')] });
    }

    // ── Event delegation ──────────────────────────────────────────
    document.addEventListener('click', e => {
      const t = e.target;

      // Open from agent item
      if (t.closest('#promptBuilderItem')) { pbOpen(); return; }

      // Category card
      if (t.closest('.pb-category-card')) {
        PbState.setState({ currentView: 'actions', selectedCategory: t.closest('.pb-category-card').dataset.category });
        return;
      }

      // Back to categories
      if (t.id === 'pb-back-to-categories' || t.closest('#pb-back-to-categories')) {
        PbState.setState({ currentView: 'categories', selectedCategory: null }); return;
      }
      if (t.id === 'pb-back-to-categories-from-result' || t.closest('#pb-back-to-categories-from-result')) {
        PbState.setState({ currentView: 'categories', selectedCategory: null }); return;
      }

      // Action button
      if (t.closest('.pb-action-btn')) {
        const actionId = t.closest('.pb-action-btn').dataset.action;
        PbState.setState({ currentView: 'form', selectedAction: actionId });
        pbRenderForm(actionId);
        return;
      }

      // Back to actions (from form dialog)
      if (t.id === 'pb-back-to-actions' || t.closest('#pb-back-to-actions')) {
        pbCloseForm(); return;
      }

      // Edit prompt toggle
      if (t.id === 'pb-edit-prompt') {
        const box = document.getElementById('pb-prompt-text');
        const editing = box.contentEditable === 'true';
        box.contentEditable = editing ? 'false' : 'true';
        t.textContent = editing ? 'Edit' : 'Done';
        if (!editing) box.focus();
        if (editing) PbState.generatedPrompt = box.textContent;
        return;
      }

      // Copy prompt
      if (t.id === 'pb-copy-prompt' || t.closest('#pb-copy-prompt')) {
        const text = document.getElementById('pb-prompt-text').textContent;
        navigator.clipboard?.writeText(text).then(() => pbShowToast('Copied to clipboard!')).catch(() => pbShowToast('Copy failed'));
        return;
      }

      // Use prompt → insert into agent chat input
      if (t.id === 'pb-use-prompt' || t.closest('#pb-use-prompt')) {
        const text = document.getElementById('pb-prompt-text').textContent;
        pbUsePrompt(text);
        return;
      }

      // Start over
      if (t.id === 'pb-start-over') { PbState.setState({ currentView: 'categories' }); return; }
    });

    // ESC closes prompt builder
    document.addEventListener('keydown', e => {
      if (e.key !== 'Escape') return;
      const pbOvr = document.getElementById('pb-overlay');
      if (pbOvr.style.display === 'flex') { pbClose(); }
    });
  </script>
</body>
</html>
